<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akashic Records - Indexing Manager</title>
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-hover: #1f3460;
            --accent: #e94560;
            --accent-green: #00d26a;
            --accent-yellow: #ffc107;
            --accent-blue: #4cc9f0;
            --text: #eef0f2;
            --text-dim: #8b8fa3;
            --border: #2a3f5f;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 span { color: var(--accent); }

        .stats-bar {
            display: flex;
            gap: 30px;
            font-size: 0.9rem;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-blue);
        }

        .stat-label { color: var(--text-dim); }

        .service-status {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .service {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent);
        }

        .status-dot.ok { background: var(--accent-green); }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-num {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.done {
            background: rgba(0, 210, 106, 0.2);
            color: var(--accent-green);
        }

        .status-badge.pending {
            background: rgba(139, 143, 163, 0.2);
            color: var(--text-dim);
        }

        .status-badge.running {
            background: rgba(255, 193, 7, 0.2);
            color: var(--accent-yellow);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .paths {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .paths code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover { background: #d63355; }

        .btn-secondary {
            background: var(--bg-hover);
            color: var(--text);
        }

        .btn-secondary:hover { background: #2a4a7f; }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-blue));
            border-radius: 3px;
            transition: width 0.3s;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 8px;
        }

        .done-time {
            font-size: 0.75rem;
            color: var(--accent-green);
            margin-top: 5px;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(233, 69, 96, 0.4);
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            background: #d63355;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
        }

        .modal h2 { margin-bottom: 20px; }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span>Akashic</span> Indexing Manager</h1>
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="total-files">-</div>
                    <div class="stat-label">Files</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="total-chunks">-</div>
                    <div class="stat-label">Chunks</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="completed-count">0/16</div>
                    <div class="stat-label">Partitions</div>
                </div>
            </div>
        </header>

        <div class="service-status">
            <div class="service">
                <div class="status-dot" id="qdrant-status"></div>
                <span>Qdrant</span>
            </div>
            <div class="service">
                <div class="status-dot" id="ollama-status"></div>
                <span>Ollama</span>
            </div>
            <div class="service">
                <div class="status-dot" id="api-status"></div>
                <span>API Server</span>
            </div>
        </div>

        <div class="grid" id="partitions-grid">
            <!-- Cards will be populated by JavaScript -->
        </div>
    </div>

    <button class="refresh-btn" onclick="refreshAll()" title="Refresh Status">‚Üª</button>

    <div class="modal" id="run-modal">
        <div class="modal-content">
            <h2>Run Indexing</h2>
            <p style="margin-bottom: 15px;">Run this batch file in Windows Explorer:</p>
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; font-family: monospace; font-size: 0.85rem; word-break: break-all;" id="bat-path"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" onclick="copyPath()">üìã Copy Path</button>
                <button class="btn btn-secondary" onclick="markAsRunning()">Mark Running</button>
            </div>
            <p style="margin-top: 15px; font-size: 0.8rem; color: var(--text-dim);">
                Tip: Press Win+R, paste the path, and press Enter
            </p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://10.14.0.33:8088';

        const partitions = [
            {
                id: '01_runtime_core',
                name: 'Runtime Core',
                paths: ['Runtime/Core', 'Runtime/BaseClasses', 'Runtime/Utilities', 'Runtime/Math', 'Runtime/Containers', 'Runtime/Threads']
            },
            {
                id: '02_rendering',
                name: 'Rendering',
                paths: ['Runtime/Graphics', 'Runtime/GfxDevice', 'Runtime/Camera', 'Runtime/Shaders', 'Runtime/GI', 'Shaders']
            },
            {
                id: '03_srp_packages',
                name: 'SRP Packages',
                paths: ['Packages/com.unity.render-pipelines.core', 'Packages/com.unity.render-pipelines.universal', 'Packages/com.unity.render-pipelines.high-definition']
            },
            {
                id: '04_scripting',
                name: 'Scripting',
                paths: ['Runtime/Scripting', 'Runtime/Mono', 'Runtime/ScriptingBackend', 'Runtime/Export', 'Runtime/GameCode']
            },
            {
                id: '05_animation',
                name: 'Animation',
                paths: ['Modules/Animation', 'Modules/Director', 'Runtime/Director']
            },
            {
                id: '06_physics',
                name: 'Physics',
                paths: ['Modules/Physics', 'Modules/Physics2D', 'Modules/Cloth', 'Modules/Vehicles']
            },
            {
                id: '07_ui',
                name: 'UI Systems',
                paths: ['Modules/IMGUI', 'Modules/UIElements', 'Modules/UIElementsNative', 'Modules/TextCore']
            },
            {
                id: '08_audio',
                name: 'Audio & Video',
                paths: ['Modules/Audio', 'Modules/DSPGraph', 'Modules/Video', 'Runtime/Video']
            },
            {
                id: '09_ai_nav',
                name: 'AI & Navigation',
                paths: ['Modules/AI', 'Modules/AIEditor']
            },
            {
                id: '10_input_xr',
                name: 'Input & XR',
                paths: ['Runtime/Input', 'Modules/XR', 'Modules/VR', 'Modules/AR']
            },
            {
                id: '11_ecs_jobs',
                name: 'ECS & Jobs',
                paths: ['Runtime/Jobs', 'Runtime/Burst', 'Packages/com.unity.entities', 'Packages/com.unity.collections']
            },
            {
                id: '12_asset_serialization',
                name: 'Asset & Serialization',
                paths: ['Modules/AssetBundle', 'Modules/AssetDatabase', 'Runtime/Serialize', 'Runtime/Resources']
            },
            {
                id: '13_editor',
                name: 'Editor',
                paths: ['Editor']
            },
            {
                id: '14_networking',
                name: 'Networking',
                paths: ['Runtime/Network', 'Modules/Multiplayer', 'Modules/UNet']
            },
            {
                id: '15_terrain_2d',
                name: 'Terrain & 2D',
                paths: ['Modules/Terrain', 'Runtime/2D', 'Packages/com.unity.2d.sprite', 'Packages/com.unity.2d.tilemap']
            },
            {
                id: '16_modules_rendering',
                name: 'Modules Rendering',
                paths: ['Modules/GI', 'Modules/ParticleSystem', 'Modules/VFX', 'Modules/SpriteMask']
            }
        ];

        let pendingPartition = null;

        function renderPartitions() {
            const grid = document.getElementById('partitions-grid');
            grid.innerHTML = partitions.map((p, i) => `
                <div class="card" data-id="${p.id}">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-num">${String(i + 1).padStart(2, '0')}</span>
                            ${p.name}
                        </div>
                        <span class="status-badge pending" id="status-${p.id}">Pending</span>
                    </div>
                    <div class="paths">
                        ${p.paths.map(path => `<code>${path}</code>`).join(' ')}
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-primary" onclick="runIndexing('${p.id}')">
                            ‚ñ∂ Run
                        </button>
                        <button class="btn btn-secondary" onclick="openFolder('${p.id}')">
                            üìÅ Open
                        </button>
                    </div>
                    <div class="done-time" id="time-${p.id}" style="display:none;"></div>
                </div>
            `).join('');
        }

        async function checkServices() {
            // Qdrant
            try {
                await fetch('http://localhost:6333/collections', { mode: 'no-cors' });
                document.getElementById('qdrant-status').classList.add('ok');
            } catch {
                document.getElementById('qdrant-status').classList.remove('ok');
            }

            // Ollama
            try {
                await fetch('http://localhost:11434/api/tags', { mode: 'no-cors' });
                document.getElementById('ollama-status').classList.add('ok');
            } catch {
                document.getElementById('ollama-status').classList.remove('ok');
            }

            // API
            try {
                const res = await fetch(`${API_BASE}/health`);
                if (res.ok) {
                    document.getElementById('api-status').classList.add('ok');
                }
            } catch {
                document.getElementById('api-status').classList.remove('ok');
            }
        }

        async function checkIndexingStatus() {
            try {
                // Use the new server API to check .done files
                const res = await fetch(`${API_BASE}/api/indexing-status`);
                const data = await res.json();

                if (data.summary) {
                    document.getElementById('total-files').textContent = data.summary.indexed_files.toLocaleString();
                    document.getElementById('total-chunks').textContent = data.summary.indexed_chunks.toLocaleString();
                    document.getElementById('completed-count').textContent =
                        `${data.summary.completed}/${data.summary.total}`;
                }

                if (data.partitions) {
                    updatePartitionUI(data.partitions);
                }
            } catch (e) {
                console.error('Failed to fetch status:', e);
                // Fallback to localStorage
                await checkPartitionStatusLocal();
            }
        }

        function updatePartitionUI(serverPartitions) {
            for (const p of partitions) {
                const statusEl = document.getElementById(`status-${p.id}`);
                const timeEl = document.getElementById(`time-${p.id}`);
                const serverStatus = serverPartitions[p.id];

                // Check localStorage for running status
                const localStatus = localStorage.getItem(`akashic_index_${p.id}`);
                let isRunning = false;
                if (localStatus) {
                    const local = JSON.parse(localStatus);
                    isRunning = local.running && !local.done;
                }

                if (serverStatus && serverStatus.status === 'done') {
                    statusEl.textContent = 'Done';
                    statusEl.className = 'status-badge done';
                    timeEl.textContent = `Completed: ${serverStatus.timestamp}`;
                    timeEl.style.display = 'block';
                    // Clear running flag in localStorage
                    localStorage.removeItem(`akashic_index_${p.id}`);
                } else if (isRunning) {
                    statusEl.textContent = 'Running...';
                    statusEl.className = 'status-badge running';
                    timeEl.style.display = 'none';
                } else {
                    statusEl.textContent = 'Pending';
                    statusEl.className = 'status-badge pending';
                    timeEl.style.display = 'none';
                }
            }
        }

        async function checkPartitionStatusLocal() {
            let completed = 0;

            for (const p of partitions) {
                const statusEl = document.getElementById(`status-${p.id}`);
                const timeEl = document.getElementById(`time-${p.id}`);

                // Check via localStorage (client-side tracking)
                const status = localStorage.getItem(`akashic_index_${p.id}`);

                if (status) {
                    const data = JSON.parse(status);
                    if (data.done) {
                        statusEl.textContent = 'Done';
                        statusEl.className = 'status-badge done';
                        timeEl.textContent = `Completed: ${data.time}`;
                        timeEl.style.display = 'block';
                        completed++;
                    } else if (data.running) {
                        statusEl.textContent = 'Running...';
                        statusEl.className = 'status-badge running';
                    }
                }
            }

            document.getElementById('completed-count').textContent = `${completed}/${partitions.length}`;
        }

        function runIndexing(id) {
            pendingPartition = id;
            const fullPath = `C:\\TA\\AI\\AkashicRecords_CodeIndexSystem\\scripts\\indexing\\${id}.bat`;
            document.getElementById('bat-path').textContent = fullPath;
            document.getElementById('run-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('run-modal').classList.remove('active');
            pendingPartition = null;
        }

        function copyPath() {
            const path = document.getElementById('bat-path').textContent;
            navigator.clipboard.writeText(path).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => { btn.textContent = originalText; }, 1500);
            });
        }

        function markAsRunning() {
            if (pendingPartition) {
                localStorage.setItem(`akashic_index_${pendingPartition}`, JSON.stringify({
                    running: true,
                    startTime: new Date().toISOString()
                }));
                closeModal();
                checkIndexingStatus();
            }
        }

        function openFolder(id) {
            const fullPath = `C:\\TA\\AI\\AkashicRecords_CodeIndexSystem\\scripts\\indexing\\`;
            navigator.clipboard.writeText(fullPath).then(() => {
                alert(`Path copied!\n\n${fullPath}\n\nPaste in Windows Explorer (Win+E)`);
            });
        }

        function markAsDone(id) {
            localStorage.setItem(`akashic_index_${id}`, JSON.stringify({
                done: true,
                time: new Date().toLocaleString()
            }));
            checkPartitionStatus();
        }

        function resetStatus(id) {
            localStorage.removeItem(`akashic_index_${id}`);
            checkPartitionStatus();
        }

        function refreshAll() {
            checkServices();
            checkIndexingStatus();
        }

        // Initialize
        renderPartitions();
        refreshAll();

        // Auto-refresh every 30 seconds
        setInterval(refreshAll, 30000);

        // Expose functions for debugging
        window.markAsDone = markAsDone;
        window.resetStatus = resetStatus;
    </script>
</body>
</html>
